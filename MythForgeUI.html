<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Myth Forge</title>
    <style>
        /* --- Theme Variables copied from LocalLLMChatv2 --- */
        :root {
            --primary: #10a37f;
            --bg-color: #ffffff;
            --text-color: #333333;
            --chat-bg: #f7f7f8;
            --user-msg-bg: #10a37f;
            --user-msg-color: white;
            --ai-msg-bg: white;
            --ai-msg-color: #333333;
            --border-color: #e5e5e5;
            --sidebar-bg: #202123;
            --sidebar-text: white;
            --sidebar-btn-bg: #343541;
            --sidebar-btn-hover: #40414f;
            --code-bg: #f0f0f0;
            --code-color: #333333;
            --input-bg: #ffffff;
            --hover-color: rgba(16, 163, 127, 0.1);
            --shadow-color: rgba(16, 163, 127, 0.2);
        }
        [data-theme="dark"] {
            --primary: #10a37f;
            --bg-color: #1e1e2e;
            --text-color: #e0e0e0;
            --chat-bg: #2c2c3a;
            --user-msg-bg: #10a37f;
            --user-msg-color: white;
            --ai-msg-bg: #343541;
            --ai-msg-color: #e0e0e0;
            --border-color: #3e3e4a;
            --sidebar-bg: #18181a;
            --sidebar-text: #e0e0e0;
            --sidebar-btn-bg: #2c2c3a;
            --sidebar-btn-hover: #3e3e4a;
            --code-bg: #2d2d3a;
            --code-color: #e0e0e0;
            --input-bg: #343541;
            --hover-color: rgba(16, 163, 127, 0.2);
            --shadow-color: rgba(16, 163, 127, 0.3);
        }
        [data-theme="night-blue"] {
            --primary: #61afef;
            --bg-color: #1a1b26;
            --text-color: #a9b1d6;
            --chat-bg: #24283b;
            --user-msg-bg: #61afef;
            --user-msg-color: #1a1b26;
            --ai-msg-bg: #2a2e42;
            --ai-msg-color: #a9b1d6;
            --border-color: #343a52;
            --sidebar-bg: #16161e;
            --sidebar-text: #a9b1d6;
            --sidebar-btn-bg: #24283b;
            --sidebar-btn-hover: #2a2e42;
            --code-bg: #282c40;
            --code-color: #a9b1d6;
            --input-bg: #2a2e42;
            --hover-color: rgba(97, 175, 239, 0.2);
            --shadow-color: rgba(97, 175, 239, 0.3);
        }
        [data-theme="sepia"] {
            --primary: #8c6c4e;
            --bg-color: #f0e7da;
            --text-color: #5c4b3c;
            --chat-bg: #f8f0e3;
            --user-msg-bg: #8c6c4e;
            --user-msg-color: #f8f0e3;
            --ai-msg-bg: #e8dccb;
            --ai-msg-color: #5c4b3c;
            --border-color: #d2c2ad;
            --sidebar-bg: #e0d0b8;
            --sidebar-text: #5c4b3c;
            --sidebar-btn-bg: #d0bea6;
            --sidebar-btn-hover: #c0af98;
            --code-bg: #e0d0b8;
            --code-color: #5c4b3c;
            --input-bg: #e8dccb;
            --hover-color: rgba(140, 108, 78, 0.1);
            --shadow-color: rgba(140, 108, 78, 0.2);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .app-container { display: flex; width: 100%; height: 100%; }
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        .sidebar button { cursor: pointer; }
        .sidebar button.new-chat {
            background-color: var(--sidebar-btn-bg);
            color: var(--sidebar-text);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 12px;
            text-align: left;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .sidebar button.new-chat:hover { background-color: var(--sidebar-btn-hover); }
        .history-container { flex-grow: 1; overflow-y: auto; }
        .chat-history-item {
            padding: 10px; margin-bottom: 5px; border-radius: 4px; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px;
        }
        .chat-history-item:hover { background-color: var(--sidebar-btn-hover); }
        .theme-switcher { margin-bottom: 12px; display: flex; flex-direction: column; }
        .theme-switcher select {
            background-color: var(--sidebar-btn-bg); color: var(--sidebar-text); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 8px; margin-top: 5px; cursor: pointer; font-size: 14px;
        }
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;}
        .modal-content{background:var(--bg-color);color:var(--text-color);padding:20px;border-radius:8px;min-width:250px;}
        .modal-content label{display:block;margin-top:10px;}
        .modal-actions{text-align:right;margin-top:15px;}
        .main { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; }
        .top-controls { padding: 10px; border-bottom: 1px solid var(--border-color); background: var(--bg-color); display: flex; gap: 0.5em; align-items: center; }
        .chat-container { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; background-color: var(--chat-bg); }
        .message { padding: 20px; margin: 0; display: flex; border-bottom: 1px solid var(--border-color); }
        .user-message { background-color: var(--bg-color); }
        .ai-message { background-color: var(--chat-bg); }
        .avatar { width: 30px; height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; }
        .user-avatar { background-color: var(--user-msg-bg); color: var(--user-msg-color); }
        .ai-avatar { background-color: var(--primary); color: white; }
        .message-content { flex-grow: 1; max-width: 800px; line-height: 1.6; }
        pre { background-color: var(--code-bg); color: var(--code-color); padding: 10px; border-radius: 4px; overflow-x: auto; }
        textarea { width: 100%; padding: 12px 45px 12px 12px; border: 1px solid var(--border-color); border-radius: 6px; resize: none; min-height: 24px; max-height: 200px; overflow-y: auto; font-family: inherit; font-size: 16px; line-height: 1.4; background-color: var(--input-bg); color: var(--text-color); }
        textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--shadow-color); }
        .input-area { border-top: 1px solid var(--border-color); padding: 20px; background-color: var(--bg-color); position: relative; }
        .input-container { display: flex; width: 100%; max-width: 800px; margin: 0 auto; position: relative; }
        .send-button { position: absolute; right: 8px; bottom: 8px; background: none; border: none; cursor: pointer; color: var(--primary); padding: 5px; border-radius: 4px; }
        #system-container { display:none; padding:10px; background: var(--chat-bg); }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <button class="new-chat" id="new-chat-btn">New Chat</button>
            <div class="sidebar-section">
                <label for="globalPromptSelect">Global Prompt</label>
                <select id="globalPromptSelect">
                    <option value="">(no global prompt)</option>
                </select>
                <button id="edit-prompt-btn">Edit Prompt</button>
                <button id="add-prompt-btn">Add Prompt</button>
            </div>
            <div class="history-container" id="history-container"></div>
            <button id="open-settings-btn" class="new-chat">Settings</button>
            <button id="delete-chat-btn" class="new-chat" style="margin-top:10px;background-color:rgba(220,53,69,0.8);">Delete Chat</button>
            <button id="system-toggle" class="new-chat" style="display:none;margin-top:10px;">⚙️ Last Prompt</button>
        </div>
        <div class="main">
            <div class="top-controls"></div>
            <div id="system-container"><pre id="system-prompt" style="white-space:pre-wrap; margin:0;"></pre></div>
            <div class="chat-container" id="chat-container"></div>
            <div class="input-area">
                <div class="input-container">
                    <textarea id="user-input" placeholder="Type a message..." rows="1"></textarea>
                    <button id="send-button" class="send-button" disabled>
                        <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="20" width="20" xmlns="http://www.w3.org/2000/svg">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2>Settings</h2>
            <label>User Display Name <input id="user-name-input" type="text"></label>
            <label>Bot Display Name <input id="bot-name-input" type="text"></label>
            <div class="theme-switcher">
                <label for="theme-select">Theme</label>
                <select id="theme-select">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="night-blue">Night Blue</option>
                    <option value="sepia">Sepia</option>
                </select>
            </div>
            <div class="modal-actions">
                <button id="settings-save-btn">Save</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = { apiUrl: 'http://localhost:8000' };
        const state = { chats: [], currentChatId: '', settings:{ userName:'You', botName:'Bot', theme:'light' }, isGenerating: false };

        const chatContainer    = document.getElementById('chat-container');
        const userInput        = document.getElementById('user-input');
        const sendButton       = document.getElementById('send-button');
        const newChatButton    = document.getElementById('new-chat-btn');
        const historyContainer = document.getElementById('history-container');
        const themeSelect      = document.getElementById('theme-select');
        const gpSelect         = document.getElementById('globalPromptSelect');
        const editPromptBtn    = document.getElementById('edit-prompt-btn');
        const addPromptBtn     = document.getElementById('add-prompt-btn');
        const deleteChatBtn    = document.getElementById('delete-chat-btn');
        const systemToggle     = document.getElementById('system-toggle');
        const systemContainer  = document.getElementById('system-container');
        const systemPrompt     = document.getElementById('system-prompt');
        const openSettingsBtn  = document.getElementById('open-settings-btn');
        const settingsModal    = document.getElementById('settings-modal');
        const settingsSaveBtn  = document.getElementById('settings-save-btn');
        const userNameInput    = document.getElementById('user-name-input');
        const botNameInput     = document.getElementById('bot-name-input');

        function applyTheme(name){
            document.body.setAttribute('data-theme', name);
            state.settings.theme = name;
        }

        function loadSettings(){
            const saved = localStorage.getItem('clientSettings');
            if(saved){
                try{ Object.assign(state.settings, JSON.parse(saved)); }catch{}
            }
        }

        function saveSettings(){
            localStorage.setItem('clientSettings', JSON.stringify(state.settings));
        }

        function loadTheme(){
            applyTheme(state.settings.theme);
            themeSelect.value = state.settings.theme;
        }

        function openSettings(){
            userNameInput.value = state.settings.userName;
            botNameInput.value  = state.settings.botName;
            themeSelect.value   = state.settings.theme;
            settingsModal.style.display='flex';
        }

        function closeSettings(){ settingsModal.style.display='none'; }

        function updateAvatarDisplays(){
            document.querySelectorAll('.user-avatar').forEach(el=>{
                el.textContent = (state.settings.userName[0] || 'U');
            });
            document.querySelectorAll('.ai-avatar').forEach(el=>{
                el.textContent = (state.settings.botName[0] || 'A');
            });
        }

        function saveSettingsFromUI(){
            state.settings.userName = userNameInput.value.trim() || 'You';
            state.settings.botName  = botNameInput.value.trim()  || 'Bot';
            applyTheme(themeSelect.value);
            saveSettings();
            updateAvatarDisplays();
            closeSettings();
        }

        function toggleSystem(){ systemContainer.style.display = systemContainer.style.display === 'none' ? 'block':'none'; }

        function renderHistory(){
            historyContainer.innerHTML = '';
            state.chats.forEach(id => {
                const div = document.createElement('div');
                div.className = 'chat-history-item';
                div.textContent = id;
                div.onclick = () => loadChat(id);
                if(id === state.currentChatId) div.style.backgroundColor = 'var(--sidebar-btn-hover)';
                historyContainer.appendChild(div);
            });
        }

        async function fetchChatList(){
            try{
                const res = await fetch(`${CONFIG.apiUrl}/chats`);
                const json = await res.json();
                state.chats = json.chats;
                const last = localStorage.getItem('lastChatId');
                if(last && state.chats.includes(last)){
                    state.currentChatId = last;
                }else if(state.chats.length && !state.currentChatId){
                    state.currentChatId = state.chats[0];
                }
                renderHistory();
            }catch(e){ console.error('Failed to fetch chats:', e); }
        }

        async function loadChat(id){
            state.currentChatId = id;
            localStorage.setItem('lastChatId', id);
            renderHistory();
            chatContainer.innerHTML='';
            systemPrompt.textContent='';
            systemToggle.style.display='none';
            try{
                const res = await fetch(`${CONFIG.apiUrl}/history/${encodeURIComponent(id)}`);
                if(!res.ok) return;
                const msgs = await res.json();
                msgs.forEach(m => appendMessageToUI(m.role==='bot'?'assistant':m.role, m.content));
            }catch(e){ console.error('Failed to load history:',e); }
        }

        async function refreshGlobalPromptList(){
            try{
                const res = await fetch(`${CONFIG.apiUrl}/prompts`);
                const json = await res.json();
                gpSelect.innerHTML = '<option value="">(no global prompt)</option>';
                json.prompts.forEach(p => { const opt=document.createElement('option'); opt.value=p.name; opt.textContent=p.name; gpSelect.appendChild(opt); });
                const last = localStorage.getItem('lastGlobalPrompt');
                if(last && Array.from(gpSelect.options).some(o=>o.value===last)) gpSelect.value = last;
            }catch(e){ console.error('Failed to load prompts:',e); }
        }

        async function addNewPrompt(){
            const name = prompt('Enter a unique prompt name (no spaces):');
            if(name===null) return; const trimmed=name.trim(); if(!trimmed) return alert('Name cannot be empty.');
            const content = prompt(`Enter the text for "${trimmed}":`); if(content===null) return; const contTrim=content.trim(); if(!contTrim) return alert('Prompt content cannot be empty.');
            try{
                const res = await fetch(`${CONFIG.apiUrl}/prompts`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name: trimmed, content: contTrim})});
                if(!res.ok){ const err=await res.json(); return alert('Error: '+err.detail); }
                await refreshGlobalPromptList();
                alert(`Prompt "${trimmed}" created.`);
            }catch(e){ console.error('Failed to create prompt:',e); alert('Failed: '+e.message); }
        }

        async function openPromptEditor(){
            const name = gpSelect.value; if(!name) return alert('Select a prompt from the dropdown first.');
            try{
                const res = await fetch(`${CONFIG.apiUrl}/prompts`); const json = await res.json();
                const promptObj = json.prompts.find(p=>p.name===name); if(!promptObj) return alert('Prompt not found.');
                const newContent = prompt(`Edit content for "${name}":`, promptObj.content); if(newContent===null) return; const contTrim = newContent.trim(); if(!contTrim) return alert('Prompt content cannot be empty.');
                const updateRes = await fetch(`${CONFIG.apiUrl}/prompts/${encodeURIComponent(name)}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, content: contTrim})});
                if(!updateRes.ok){ const err=await updateRes.json(); return alert('Error: '+err.detail); }
                await refreshGlobalPromptList(); alert(`Prompt "${name}" updated.`);
            }catch(e){ console.error('Failed to update prompt:',e); alert('Failed to update prompt: '+e.message); }
        }

        function startNewChat(){
            const name = prompt('Enter new chat name:'); if(name===null) return; const trimmed = name.trim(); if(!trimmed) return alert('Name cannot be empty.');
            if(state.chats.includes(trimmed)) return alert('That name\u2019s already taken.');
              state.chats.unshift(trimmed);
              state.currentChatId = trimmed;
              localStorage.setItem('lastChatId', trimmed);
              renderHistory();
              chatContainer.innerHTML = '';
              systemPrompt.textContent = '';
              systemToggle.style.display = 'none';
        }

        async function deleteChat(){
            if(!state.currentChatId) return alert('Nothing to delete.');
            if(!confirm('Are you sure you want to delete this chat?')) return;
            try{
                const res = await fetch(`${CONFIG.apiUrl}/chat/${encodeURIComponent(state.currentChatId)}`, {method:'DELETE'});
                if(!res.ok){ if(res.status===404) throw new Error('Chat not found on server.'); else throw new Error('Unknown server error.'); }
                state.chats = state.chats.filter(c=>c!==state.currentChatId);
                state.currentChatId = state.chats.length? state.chats[0] : '';
                localStorage.setItem('lastChatId', state.currentChatId);
                renderHistory();
                chatContainer.innerHTML = '';
                systemPrompt.textContent = '';
                systemToggle.style.display = 'none';
            }catch(err){ console.error('Failed to delete chat:', err); alert('Error deleting chat: '+err.message); }
        }

        function autoResize(){ userInput.style.height='auto'; userInput.style.height=Math.min(userInput.scrollHeight,200)+'px'; }

        function appendMessageToUI(role, content){
            const div=document.createElement('div');
            div.className=`message ${role==='user'?'user-message':'ai-message'}`;
            const avatar=document.createElement('div');
            avatar.className=`avatar ${role==='user'?'user-avatar':'ai-avatar'}`;
            avatar.textContent = role==='user' ? (state.settings.userName[0]||'U') : (state.settings.botName[0]||'A');
            const contentDiv=document.createElement('div');
            contentDiv.className='message-content';
            contentDiv.innerHTML=content.replace(/\n/g,'<br>');
            div.appendChild(avatar); div.appendChild(contentDiv);
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addTyping(){
            const div=document.createElement('div'); div.className='message ai-message'; div.id='typing-indicator';
            const avatar=document.createElement('div'); avatar.className='avatar ai-avatar'; avatar.textContent=(state.settings.botName[0]||'A');
            const cont=document.createElement('div'); cont.className='message-content'; cont.textContent='...';
            div.appendChild(avatar); div.appendChild(cont); chatContainer.appendChild(div); chatContainer.scrollTop=chatContainer.scrollHeight;
        }
        function removeTyping(){ const t=document.getElementById('typing-indicator'); if(t) t.remove(); }

        async function sendMessage(){
            const text = userInput.value.trim();
            if(text==='' || state.isGenerating || !state.currentChatId) return;
            userInput.value=''; autoResize(); sendButton.disabled=true;
            appendMessageToUI('user', text);
            addTyping(); state.isGenerating=true;
            try{
                const response = await fetch(`${CONFIG.apiUrl}/chat/stream`, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({chat_id: state.currentChatId, message: text, global_prompt: gpSelect.value})
                });
                if(!response.ok) throw new Error(`Server returned ${response.status}`);
                removeTyping();
                appendMessageToUI('assistant','');
                const aiElement = chatContainer.lastChild.querySelector('.message-content');
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer=''; let done=false; let firstLine=true; let accumulated='';
                while(!done){
                    const {value, done:doneReading} = await reader.read();
                    done = doneReading;
                    if(value){
                        buffer += decoder.decode(value, {stream:true});
                        while(buffer.includes('\n')){
                            const idx = buffer.indexOf('\n');
                            const chunk = buffer.slice(0, idx); buffer = buffer.slice(idx+1);
                            if(firstLine){
                                firstLine=false;
                                try{
                                    const meta=JSON.parse(chunk);
                                    systemPrompt.textContent = meta.prompt || '';
                                    systemToggle.style.display = meta.prompt ? 'block' : 'none';
                                }catch{}
                            }else{
                                accumulated += chunk; aiElement.innerHTML = accumulated.replace(/\n/g,'<br>');
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }
                        }
                    }
                }
            }catch(err){
                console.error('Streaming fetch failed:', err);
                removeTyping(); appendMessageToUI('assistant','[Error generating response]');
            }finally{
                state.isGenerating=false; sendButton.disabled=userInput.value.trim()===''; userInput.focus();
            }
        }

        function setupEvents(){
            themeSelect.addEventListener('change', e=>applyTheme(e.target.value));
            gpSelect.addEventListener('change', ()=>{ localStorage.setItem('lastGlobalPrompt', gpSelect.value); });
            openSettingsBtn.addEventListener('click', openSettings);
            settingsSaveBtn.addEventListener('click', saveSettingsFromUI);
            settingsModal.addEventListener('click', e=>{ if(e.target===settingsModal) closeSettings(); });
            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
            userInput.addEventListener('input', ()=>{ sendButton.disabled = userInput.value.trim()==='' || state.isGenerating; autoResize(); });
            newChatButton.addEventListener('click', startNewChat);
            deleteChatBtn.addEventListener('click', deleteChat);
            editPromptBtn.addEventListener('click', openPromptEditor);
            addPromptBtn.addEventListener('click', addNewPrompt);
            systemToggle.addEventListener('click', toggleSystem);
        }

        (async function init(){
            loadSettings();
            loadTheme();
            setupEvents();
            await fetchChatList();
            if(state.currentChatId) await loadChat(state.currentChatId);
            await refreshGlobalPromptList();
            autoResize();
        })();
    </script>
</body>
</html>
