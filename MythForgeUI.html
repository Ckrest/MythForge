<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Myth Forge</title>
    <style>
        /* --- Theme Variables copied from LocalLLMChatv2 --- */
        :root {
            --primary: #10a37f;
            --bg-color: #ffffff;
            --text-color: #333333;
            --chat-bg: #f7f7f8;
            --user-msg-bg: #10a37f;
            --user-msg-color: white;
            --ai-msg-bg: white;
            --ai-msg-color: #333333;
            --border-color: #e5e5e5;
            --sidebar-bg: #202123;
            --sidebar-text: white;
            --sidebar-btn-bg: #343541;
            --sidebar-btn-hover: #40414f;
            --code-bg: #f0f0f0;
            --code-color: #333333;
            --input-bg: #ffffff;
            --hover-color: rgba(16, 163, 127, 0.1);
            --shadow-color: rgba(16, 163, 127, 0.2);
            --message-font-size: 16px;
        }
        [data-theme="dark"] {
            --primary: #10a37f;
            --bg-color: #1e1e2e;
            --text-color: #e0e0e0;
            --chat-bg: #2c2c3a;
            --user-msg-bg: #10a37f;
            --user-msg-color: white;
            --ai-msg-bg: #343541;
            --ai-msg-color: #e0e0e0;
            --border-color: #3e3e4a;
            --sidebar-bg: #18181a;
            --sidebar-text: #e0e0e0;
            --sidebar-btn-bg: #2c2c3a;
            --sidebar-btn-hover: #3e3e4a;
            --code-bg: #2d2d3a;
            --code-color: #e0e0e0;
            --input-bg: #343541;
            --hover-color: rgba(16, 163, 127, 0.2);
            --shadow-color: rgba(16, 163, 127, 0.3);
        }
        [data-theme="night-blue"] {
            --primary: #61afef;
            --bg-color: #1a1b26;
            --text-color: #a9b1d6;
            --chat-bg: #24283b;
            --user-msg-bg: #61afef;
            --user-msg-color: #1a1b26;
            --ai-msg-bg: #2a2e42;
            --ai-msg-color: #a9b1d6;
            --border-color: #343a52;
            --sidebar-bg: #16161e;
            --sidebar-text: #a9b1d6;
            --sidebar-btn-bg: #24283b;
            --sidebar-btn-hover: #2a2e42;
            --code-bg: #282c40;
            --code-color: #a9b1d6;
            --input-bg: #2a2e42;
            --hover-color: rgba(97, 175, 239, 0.2);
            --shadow-color: rgba(97, 175, 239, 0.3);
        }
        [data-theme="sepia"] {
            --primary: #8c6c4e;
            --bg-color: #f0e7da;
            --text-color: #5c4b3c;
            --chat-bg: #f8f0e3;
            --user-msg-bg: #8c6c4e;
            --user-msg-color: #f8f0e3;
            --ai-msg-bg: #e8dccb;
            --ai-msg-color: #5c4b3c;
            --border-color: #d2c2ad;
            --sidebar-bg: #e0d0b8;
            --sidebar-text: #5c4b3c;
            --sidebar-btn-bg: #d0bea6;
            --sidebar-btn-hover: #c0af98;
            --code-bg: #e0d0b8;
            --code-color: #5c4b3c;
            --input-bg: #e8dccb;
            --hover-color: rgba(140, 108, 78, 0.1);
            --shadow-color: rgba(140, 108, 78, 0.2);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .app-container { display: flex; width: 100%; height: 100%; }
        .sidebar {
            width: 260px;
            flex: 0 0 260px;
            box-sizing: border-box;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        .sidebar button { cursor: pointer; background-color: var(--sidebar-btn-bg); color: var(--sidebar-text); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; padding: 8px; font-size: 14px; }
        .sidebar button:hover { background-color: var(--sidebar-btn-hover); }
        .sidebar button.new-chat { padding: 12px; text-align: left; margin-bottom: 20px; display: flex; align-items: center; }
        .history-container { flex-grow: 1; overflow-y: auto; }
        .chat-history-item {
            width: 100%;
            box-sizing: border-box;
            padding: 10px; margin-bottom: 5px; border-radius: 4px; cursor: pointer; font-size: 14px; position: relative; display:flex; align-items:center;
        }
        .chat-name { flex-grow:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .chat-history-item:hover { background-color: var(--sidebar-btn-hover); }
        .chat-action-btn {
            background: none; border: none; color: var(--sidebar-text); font-size: 12px; cursor: pointer; margin-left:4px; display:none;
        }
        .chat-history-item.active .chat-action-btn { display:block; }
        .chat-history-item.active { background-color: var(--sidebar-btn-hover); }
        .theme-switcher { margin-bottom: 12px; display: flex; flex-direction: column; }
        .theme-switcher select {
            background-color: var(--sidebar-btn-bg); color: var(--sidebar-text); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 8px; margin-top: 5px; cursor: pointer; font-size: 14px;
        }
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;}
        .modal-content{background:var(--bg-color);color:var(--text-color);padding:20px;border-radius:8px;min-width:250px;}
        .modal-content label{display:block;margin-top:10px;}
        .modal-actions{text-align:right;margin-top:15px;}
        .main { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; }
        .top-controls { padding: 10px; border-bottom: 1px solid var(--border-color); background: var(--bg-color); display: flex; gap: 0.5em; align-items: center; }
        .chat-container { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-end; background-color: var(--chat-bg); }
        .message { padding: 20px; margin: 0; display: flex; border-bottom: 1px solid var(--border-color); position: relative; }
        .user-message { background-color: var(--bg-color); }
        .ai-message { background-color: var(--chat-bg); }
        .avatar { width: 30px; height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; }
        .user-avatar { background-color: var(--user-msg-bg); color: var(--user-msg-color); }
        .ai-avatar { background-color: var(--primary); color: white; }
        .message-content { flex-grow: 1; max-width: none; line-height: 1.6; font-size: var(--message-font-size); }
        .message-control-btn { position: absolute; bottom: 4px; right: 4px; background: none; border: none; cursor: pointer; color: var(--text-color); display: none; }
        .message:hover .message-control-btn { display: block; }
        .message-menu { position: absolute; bottom: 28px; right: 4px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; flex-direction: column; z-index: 100; }
        .message-menu button { background: none; border: none; padding: 6px 12px; cursor: pointer; font-size: 14px; text-align: left; color: var(--text-color); }
        .message-menu button:hover { background-color: var(--hover-color); }
        pre { background-color: var(--code-bg); color: var(--code-color); padding: 10px; border-radius: 4px; overflow-x: auto; }
        textarea { width: 100%; padding: 12px 110px 12px 12px; border: 1px solid var(--border-color); border-radius: 6px; resize: none; min-height: 24px; max-height: 200px; overflow-y: auto; font-family: inherit; font-size: var(--message-font-size); line-height: 1.4; background-color: var(--input-bg); color: var(--text-color); }
        textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--shadow-color); }
        .input-area { border-top: 1px solid var(--border-color); padding: 20px; background-color: var(--bg-color); position: relative; }
        .input-container { display: flex; width: 100%; max-width: none; margin: 0; position: relative; }
        .send-button { position: absolute; right: 8px; bottom: 8px; background: none; border: none; cursor: pointer; color: var(--primary); padding: 5px; border-radius: 4px; }
        #system-container { display:none; padding:10px; background: var(--chat-bg); }

        .tab-bar {
            width: 40px;
            flex: 0 0 40px;
            box-sizing: border-box;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 8px;
        }
        .tab-bar button { background-color: var(--sidebar-btn-bg); border: 1px solid rgba(255,255,255,0.2); color: var(--sidebar-text); cursor: pointer; font-size: 20px; width: 100%; padding: 10px 0; margin-bottom: 6px; border-radius: 4px; }
        .tab-bar button.active { background-color: var(--sidebar-btn-hover); }
        .sidebar.hidden { display: none; }
        #chat-section, #more-section, #prompt-section { flex-grow: 1; display: flex; flex-direction: column; }
        #more-section { overflow-y: auto; }
        #prompt-section { overflow-y: auto; }
        .sidebar-section { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .sidebar-section select { background-color: var(--sidebar-btn-bg); color: var(--sidebar-text); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 8px; cursor: pointer; font-size: 14px; }
        .sidebar-section label { display:flex; flex-direction:column; font-size:14px; }
        .sidebar-section input { background-color: var(--sidebar-btn-bg); color: var(--sidebar-text); border: 1px solid rgba(255,255,255,0.2); border-radius:4px; padding:6px 8px; margin-top:4px; font-size:14px; }
        .sidebar-section input[type=number]::-webkit-inner-spin-button,
        .sidebar-section input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .sidebar-section input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="tab-bar">
            <button id="hide-tab" title="Hide">&#8592;</button>
            <button id="chat-tab" title="Chats">&#128172;</button>
            <button id="prompt-tab" title="Global Prompt">&#128221;</button>
            <button id="more-tab" title="More">&#9881;</button>
        </div>
        <div class="sidebar" id="sidebar">
            <div id="chat-section">
                <button class="new-chat" id="new-chat-btn">New Chat</button>
                <div class="history-container" id="history-container"></div>
            </div>
            <div id="prompt-section" style="display:none;">
                <button class="new-chat" id="new-prompt-btn">New Prompt</button>
                <div class="history-container" id="prompt-list"></div>
            </div>
            <div id="more-section" style="display:none;">
                <button id="open-settings-btn" class="new-chat">Local Settings</button>
                <div class="sidebar-section" id="generation-settings">
                    <label>Max Tokens <input id="max-tokens-input" type="number" min="1"></label>
                    <label>Temperature <input id="temperature-input" type="number" step="0.01"></label>
                    <label>Top K <input id="top-k-input" type="number" min="0"></label>
                    <label>Top P <input id="top-p-input" type="number" step="0.01" min="0" max="1"></label>
                    <label>Min P <input id="min-p-input" type="number" step="0.01" min="0" max="1"></label>
                    <label>Repeat Penalty <input id="repeat-penalty-input" type="number" step="0.01" min="0"></label>
                    <button id="server-settings-save-btn">Save</button>
                </div>
                <button id="system-toggle" class="new-chat" style="display:none;margin-top:10px;">⚙️ Last Prompt</button>
            </div>
        </div>
        <div class="main">
            <div class="top-controls"></div>
            <div id="system-container"><pre id="system-prompt" style="white-space:pre-wrap; margin:0;"></pre></div>
            <div class="chat-container" id="chat-container"></div>
            <div class="input-area">
                <div class="input-container">
                    <textarea id="user-input" placeholder="Type a message..." rows="1"></textarea>
                    <button id="send-only-button" class="send-button" style="right:40px" title="Send without response" disabled>
                        &#10003;
                    </button>
                    <button id="send-button" class="send-button">
                        <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="20" width="20" xmlns="http://www.w3.org/2000/svg">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                    <button id="stop-button" class="send-button" style="display:none" title="Stop generation">
                        &#9632;
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2>Local Settings</h2>
            <label>User Display Name <input id="user-name-input" type="text"></label>
            <label>Bot Display Name <input id="bot-name-input" type="text"></label>
            <div class="theme-switcher">
                <label for="theme-select">Theme</label>
                <select id="theme-select">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="night-blue">Night Blue</option>
                    <option value="sepia">Sepia</option>
                </select>
            </div>
            <div class="theme-switcher">
                <label for="text-size-select">Text Size</label>
                <select id="text-size-select">
                    <option value="small">Small</option>
                    <option value="medium">Medium</option>
                    <option value="large">Large</option>
                    <option value="x-large">Extra Large</option>
                    <option value="xx-large">2x Large</option>
                    <option value="xxx-large">3x Large</option>
                    <option value="xxxx-large">4x Large</option>
                <option value="xxxxx-large">5x Large</option>
                </select>
            </div>
            <label>Auto Scroll Lines <input id="scroll-lines-input" type="number" min="0" value="0"></label>
            <div class="modal-actions">
                <button id="settings-save-btn">Save</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = { apiUrl: window.location.origin };
        const state = {
            chats: [],
            currentChatId: '',
            prompts: [],
            currentPrompt: '',
            settings: {
                userName: 'You',
                botName: 'Bot',
                theme: 'light',
                textSize: 'medium',
                autoScrollLines: 0
            },
            serverSettings: {
                max_tokens: 250,
                temperature: 0.8,
                top_k: 40,
                top_p: 0.95,
                min_p: 0.05,
                repeat_penalty: 1.1
            },
            isGenerating: false
        };

        const chatContainer    = document.getElementById('chat-container');
        const userInput        = document.getElementById('user-input');
        const sendButton       = document.getElementById('send-button');
        const sendOnlyButton   = document.getElementById('send-only-button');
        const stopButton       = document.getElementById('stop-button');
        let abortController    = null;
        const newChatButton    = document.getElementById('new-chat-btn');
        const historyContainer = document.getElementById('history-container');
       const themeSelect      = document.getElementById('theme-select');
        const textSizeSelect  = document.getElementById('text-size-select');
        const newPromptBtn     = document.getElementById('new-prompt-btn');
        const promptList       = document.getElementById('prompt-list');
        const systemToggle     = document.getElementById('system-toggle');
        const systemContainer  = document.getElementById('system-container');
        const systemPrompt     = document.getElementById('system-prompt');
        const openSettingsBtn  = document.getElementById('open-settings-btn');
        const settingsModal    = document.getElementById('settings-modal');
        const settingsSaveBtn  = document.getElementById('settings-save-btn');
        const userNameInput    = document.getElementById('user-name-input');
        const botNameInput     = document.getElementById('bot-name-input');
        const scrollLinesInput = document.getElementById('scroll-lines-input');
        const maxTokensInput   = document.getElementById('max-tokens-input');
        const temperatureInput = document.getElementById('temperature-input');
        const topKInput        = document.getElementById('top-k-input');
        const topPInput        = document.getElementById('top-p-input');
        const minPInput        = document.getElementById('min-p-input');
        const repeatPenaltyInput = document.getElementById('repeat-penalty-input');
        const serverSettingsSaveBtn = document.getElementById('server-settings-save-btn');
        const hideTab          = document.getElementById('hide-tab');
        const chatTab          = document.getElementById('chat-tab');
        const promptTab        = document.getElementById('prompt-tab');
        const moreTab          = document.getElementById('more-tab');
        const sidebar          = document.getElementById('sidebar');
        const chatSection      = document.getElementById('chat-section');
        const promptSection    = document.getElementById('prompt-section');
        const moreSection      = document.getElementById('more-section');

       function applyTheme(name){
           document.body.setAttribute('data-theme', name);
           state.settings.theme = name;
       }

        function applyTextSize(size){
            const map = {
                small:'14px',
                medium:'16px',
                large:'18px',
                'x-large':'20px',
                'xx-large':'22px',
                'xxx-large':'24px',
                'xxxx-large':'26px',
                'xxxxx-large':'28px'
            };
            document.body.style.setProperty('--message-font-size', map[size] || '16px');
            state.settings.textSize = size;
        }

        function loadSettings(){
            const saved = localStorage.getItem('clientSettings');
            if(saved){
                try{
                    const obj = JSON.parse(saved);
                    if(obj.userName) state.settings.userName = obj.userName;
                    if(obj.botName)  state.settings.botName  = obj.botName;
                    if(obj.theme)    state.settings.theme    = obj.theme;
                    if(obj.textSize) state.settings.textSize = obj.textSize;
                    if(typeof obj.autoScrollLines === 'number') state.settings.autoScrollLines = obj.autoScrollLines;
                }catch{}
            }
        }

        function saveSettings(){
            const obj = {
                userName: state.settings.userName,
                botName: state.settings.botName,
                theme: state.settings.theme,
                textSize: state.settings.textSize,
                autoScrollLines: state.settings.autoScrollLines
            };
            localStorage.setItem('clientSettings', JSON.stringify(obj));
        }

        function loadTheme(){
            applyTheme(state.settings.theme);
            themeSelect.value = state.settings.theme;
        }

        function loadTextSize(){
            applyTextSize(state.settings.textSize);
            textSizeSelect.value = state.settings.textSize;
        }

        async function loadServerSettings(){
            try{
                const res = await fetch('/settings');
                if(!res.ok) return;
                const data = await res.json();
                state.serverSettings = data;
                maxTokensInput.value     = data.max_tokens ?? '';
                temperatureInput.value   = data.temperature ?? '';
                topKInput.value          = data.top_k ?? '';
                topPInput.value          = data.top_p ?? '';
                minPInput.value          = data.min_p ?? '';
                repeatPenaltyInput.value = data.repeat_penalty ?? '';
            }catch(e){ console.error('Failed to load server settings:', e); }
        }

        async function saveServerSettings(){
            const payload = {
                max_tokens: parseInt(maxTokensInput.value) || 1,
                temperature: parseFloat(temperatureInput.value) || 0,
                top_k: parseInt(topKInput.value) || 0,
                top_p: parseFloat(topPInput.value) || 0,
                min_p: parseFloat(minPInput.value) || 0,
                repeat_penalty: parseFloat(repeatPenaltyInput.value) || 0
            };
            try{
                const res = await fetch('/settings', {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                if(!res.ok){
                    const err = await res.json();
                    alert('Error: ' + (err.detail || res.status));
                    return;
                }
                state.serverSettings = {...state.serverSettings, ...payload};
                alert('Settings saved');
            }catch(e){ console.error('Failed to save server settings:', e); }
        }

       function openSettings(){
            userNameInput.value = state.settings.userName;
            botNameInput.value  = state.settings.botName;
            themeSelect.value   = state.settings.theme;
            textSizeSelect.value = state.settings.textSize;
            scrollLinesInput.value = state.settings.autoScrollLines;
            settingsModal.style.display='flex';
        }

        function closeSettings(){ settingsModal.style.display='none'; }

        function updateAvatarDisplays(){
            document.querySelectorAll('.user-avatar').forEach(el=>{
                el.textContent = (state.settings.userName[0] || 'U');
            });
            document.querySelectorAll('.ai-avatar').forEach(el=>{
                el.textContent = (state.settings.botName[0] || 'A');
            });
        }

       function saveSettingsFromUI(){
            state.settings.userName = userNameInput.value.trim() || 'You';
            state.settings.botName  = botNameInput.value.trim()  || 'Bot';
            applyTheme(themeSelect.value);
            applyTextSize(textSizeSelect.value);
            state.settings.autoScrollLines = parseInt(scrollLinesInput.value) || 0;
            saveSettings();
            updateAvatarDisplays();
            closeSettings();
        }

        function toggleSystem(){
            const current = getComputedStyle(systemContainer).display;
            systemContainer.style.display = current === 'none' ? 'block' : 'none';
        }

       function showChatTab(){
            sidebar.classList.remove('hidden');
            chatSection.style.display = 'flex';
            promptSection.style.display = 'none';
            moreSection.style.display = 'none';
            chatTab.classList.add('active');
            promptTab.classList.remove('active');
            moreTab.classList.remove('active');
        }

        function showMoreTab(){
            sidebar.classList.remove('hidden');
            chatSection.style.display = 'none';
            promptSection.style.display = 'none';
            moreSection.style.display = 'flex';
            chatTab.classList.remove('active');
            promptTab.classList.remove('active');
            moreTab.classList.add('active');
        }

        function showPromptTab(){
            sidebar.classList.remove('hidden');
            chatSection.style.display = 'none';
            promptSection.style.display = 'flex';
            moreSection.style.display = 'none';
            chatTab.classList.remove('active');
            promptTab.classList.add('active');
            moreTab.classList.remove('active');
        }

        function hideSidebar(){
            sidebar.classList.add('hidden');
            chatTab.classList.remove('active');
            promptTab.classList.remove('active');
            moreTab.classList.remove('active');
        }

        function renderHistory(){
            historyContainer.innerHTML = '';
            state.chats.forEach(id => {
                const div = document.createElement('div');
                div.className = 'chat-history-item';

                if(id === state.currentChatId) div.classList.add('active');

                const nameSpan = document.createElement('span');
                nameSpan.className = 'chat-name';
                nameSpan.textContent = id;
                div.appendChild(nameSpan);

                const renameBtn = document.createElement('button');
                renameBtn.className = 'chat-action-btn';
                renameBtn.textContent = '✎';
                renameBtn.title = 'Rename chat';
                renameBtn.onclick = (e)=>{ e.stopPropagation(); renameChat(id); };
                div.appendChild(renameBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'chat-action-btn';
                deleteBtn.textContent = '✕';
                deleteBtn.title = 'Delete chat';
                deleteBtn.onclick = (e)=>{ e.stopPropagation(); deleteChat(); };
                div.appendChild(deleteBtn);

                div.onclick = () => loadChat(id);
                historyContainer.appendChild(div);
            });
        }

        function updateActiveChat(){
            const items = historyContainer.querySelectorAll('.chat-history-item');
            items.forEach(div=>{
                const name = div.querySelector('.chat-name').textContent;
                if(name === state.currentChatId){
                    div.classList.add('active');
                }else{
                    div.classList.remove('active');
                }
            });
        }

        async function fetchChatList(){
            try{
                const res = await fetch('/chats');
                const json = await res.json();
                state.chats = json.chats;
                const last = localStorage.getItem('lastChatId');
                if(last && state.chats.includes(last)){
                    state.currentChatId = last;
                }else if(state.chats.length && !state.currentChatId){
                    state.currentChatId = state.chats[0];
                }
                renderHistory();
            }catch(e){ console.error('Failed to fetch chats:', e); }
        }

        async function loadChat(id){
            state.currentChatId = id;
            localStorage.setItem('lastChatId', id);
            updateActiveChat();
            chatContainer.innerHTML='';
            systemPrompt.textContent='';
            systemToggle.style.display='none';
            try{
                const res = await fetch(`/history/${encodeURIComponent(id)}`);
                if(!res.ok) return;
                const msgs = await res.json();
                msgs.forEach(m => appendMessageToUI(m.role==='bot'?'assistant':m.role, m.content));
            }catch(e){ console.error('Failed to load history:',e); }
        }

        function renderPromptList(){
            promptList.innerHTML='';
            state.prompts.forEach(name=>{
                const div=document.createElement('div');
                div.className='chat-history-item';
                const span=document.createElement('span');
                span.className='chat-name';
                span.textContent=name;
                div.appendChild(span);
                if(name===state.currentPrompt){
                    div.classList.add('active');
                    const ren=document.createElement('button');
                    ren.className='chat-action-btn';
                    ren.textContent='✎';
                    ren.title='Rename prompt';
                    ren.onclick=(e)=>{e.stopPropagation(); renamePrompt(name);};
                    const del=document.createElement('button');
                    del.className='chat-action-btn';
                    del.textContent='✕';
                    del.title='Delete prompt';
                    del.onclick=(e)=>{e.stopPropagation(); deletePrompt(name);};
                    div.appendChild(ren); div.appendChild(del);
                }
                div.onclick=()=>selectPrompt(name);
                promptList.appendChild(div);
            });
        }

        async function refreshGlobalPromptList(){
            try{
                const res = await fetch('/prompts');
                const json = await res.json();
                state.prompts = json.prompts.map(p=>p.name);
                const last = localStorage.getItem('lastGlobalPrompt');
                if(last && state.prompts.includes(last)) state.currentPrompt = last;
                renderPromptList();
            }catch(e){ console.error('Failed to load prompts:',e); }
        }

        async function addNewPrompt(){
            const name = prompt('Enter a unique prompt name (no spaces):');
            if(name===null) return; const trimmed=name.trim(); if(!trimmed) return alert('Name cannot be empty.');
            const content = prompt(`Enter the text for "${trimmed}":`); if(content===null) return; const contTrim=content.trim(); if(!contTrim) return alert('Prompt content cannot be empty.');
            try{
                const res = await fetch('/prompts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: trimmed, content: contTrim })
                });
                if(!res.ok){
                    const err = await res.json();
                    return alert('Error: ' + err.detail);
                }
                // Remember this new prompt as the last used one
                localStorage.setItem('lastGlobalPrompt', trimmed);
                await refreshGlobalPromptList();
                state.currentPrompt = trimmed;
                renderPromptList();
                alert(`Prompt "${trimmed}" created.`);
            }catch(e){
                console.error('Failed to create prompt:', e);
                alert('Failed: ' + e.message);
            }
        }

        async function openPromptEditor(name=state.currentPrompt){
            if(!name) return alert('Select a prompt first.');
            try{
                const res = await fetch('/prompts'); const json = await res.json();
                const promptObj = json.prompts.find(p=>p.name===name); if(!promptObj) return alert('Prompt not found.');
                const newContent = prompt(`Edit content for "${name}":`, promptObj.content); if(newContent===null) return; const contTrim = newContent.trim(); if(!contTrim) return alert('Prompt content cannot be empty.');
                const updateRes = await fetch(`/prompts/${encodeURIComponent(name)}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, content: contTrim})});
                if(!updateRes.ok){ const err=await updateRes.json(); return alert('Error: '+err.detail); }
                await refreshGlobalPromptList();
                alert(`Prompt "${name}" updated.`);
            }catch(e){ console.error('Failed to update prompt:',e); alert('Failed to update prompt: '+e.message); }
        }

        function startNewChat(){
            const name = prompt('Enter new chat name:'); if(name===null) return; const trimmed = name.trim(); if(!trimmed) return alert('Name cannot be empty.');
            if(state.chats.includes(trimmed)) return alert('That name\u2019s already taken.');
              state.chats.unshift(trimmed);
              state.currentChatId = trimmed;
              localStorage.setItem('lastChatId', trimmed);
              renderHistory();
              chatContainer.innerHTML = '';
              systemPrompt.textContent = '';
              systemToggle.style.display = 'none';
        }

        async function deleteChat(){
            if(!state.currentChatId) return alert('Nothing to delete.');
            if(!confirm('Are you sure you want to delete this chat?')) return;
            try{
                const res = await fetch(`/chat/${encodeURIComponent(state.currentChatId)}`, {method:'DELETE'});
                if(!res.ok){ if(res.status===404) throw new Error('Chat not found on server.'); else throw new Error('Unknown server error.'); }
                state.chats = state.chats.filter(c=>c!==state.currentChatId);
                state.currentChatId = state.chats.length? state.chats[0] : '';
                localStorage.setItem('lastChatId', state.currentChatId);
                renderHistory();
                chatContainer.innerHTML = '';
                systemPrompt.textContent = '';
                systemToggle.style.display = 'none';
                showChatTab();
            }catch(err){ console.error('Failed to delete chat:', err); alert('Error deleting chat: '+err.message); }
        }

        async function renameChat(oldId){
            const name = prompt('Enter new chat name:', oldId); if(name===null) return;
            const trimmed = name.trim(); if(!trimmed) return alert('Name cannot be empty.');
            if(trimmed === oldId) return;
            if(state.chats.includes(trimmed)) return alert('That name\u2019s already taken.');
            try{
                const res = await fetch(`/chat/${encodeURIComponent(oldId)}`, {
                    method:'PUT',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({new_id: trimmed})
                });
                if(!res.ok && res.status!==404){
                    const err = await res.json();
                    throw new Error(err.detail||'Server error');
                }
                state.chats = state.chats.map(c=>c===oldId? trimmed:c);
                if(state.currentChatId===oldId){
                    state.currentChatId = trimmed;
                    localStorage.setItem('lastChatId', trimmed);
                }
                renderHistory();
            }catch(e){ console.error('Rename failed:', e); alert('Failed to rename chat: '+e.message); }
        }

        function selectPrompt(name){
            state.currentPrompt = name;
            localStorage.setItem('lastGlobalPrompt', name);
            renderPromptList();
        }

        async function deletePrompt(name){
            if(!confirm('Delete this prompt?')) return;
            try{
                const res = await fetch(`/prompts/${encodeURIComponent(name)}`, {method:'DELETE'});
                if(!res.ok){ const j=await res.json(); throw new Error(j.detail||'Server error'); }
                state.prompts = state.prompts.filter(p=>p!==name);
                if(state.currentPrompt===name){
                    state.currentPrompt = state.prompts.length? state.prompts[0]:'';
                    localStorage.setItem('lastGlobalPrompt', state.currentPrompt);
                }
                renderPromptList();
            }catch(e){ alert('Failed to delete prompt: '+e.message); }
        }

        async function renamePrompt(oldName){
            const newName = prompt('Enter new prompt name:', oldName);
            if(newName===null) return;
            const trimmed = newName.trim();
            if(!trimmed) return alert('Name cannot be empty.');
            if(trimmed.toLowerCase() !== oldName.trim().toLowerCase() && state.prompts.includes(trimmed))
                return alert('That name\u2019s already taken.');
            try{
                const res = await fetch(`/prompts/${encodeURIComponent(oldName)}/rename`, {
                    method:'PUT',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({new_name: trimmed})
                });
                if(!res.ok){ const j=await res.json(); throw new Error(j.detail||'Server error'); }
                state.prompts = state.prompts.map(p=>p===oldName? trimmed:p);
                state.currentPrompt = trimmed;
                localStorage.setItem('lastGlobalPrompt', trimmed);
                renderPromptList();
                await openPromptEditor(trimmed);
            }catch(e){ alert('Failed to rename prompt: '+e.message); }
        }

        function autoResize(){ userInput.style.height='auto'; userInput.style.height=Math.min(userInput.scrollHeight,200)+'px'; }

        function scrollToBottom(){
            chatContainer.scrollTop = chatContainer.scrollHeight;
            const lastMsg = chatContainer.lastElementChild;
            if(lastMsg) lastMsg.scrollIntoView({block:'end'});
        }

        let activeMenu = null;

        function closeMessageMenu(){ if(activeMenu){ activeMenu.remove(); activeMenu=null; } }

        async function editMessage(index, current){
            const text = prompt('Edit message:', current);
            if(text===null) return;
            try{
                const res = await fetch(`/history/${encodeURIComponent(state.currentChatId)}/${index}`, {
                    method:'PUT',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({content:text})
                });
                if(!res.ok){ const j=await res.json(); throw new Error(j.detail||'Server error'); }
                await loadChat(state.currentChatId);
            }catch(e){ alert('Failed to edit: '+e.message); }
        }

        async function deleteMessage(index){
            if(!confirm('Delete this message?')) return;
            try{
                const res = await fetch(`/history/${encodeURIComponent(state.currentChatId)}/${index}`, {method:'DELETE'});
                if(!res.ok){ const j=await res.json(); throw new Error(j.detail||'Server error'); }
                await loadChat(state.currentChatId);
            }catch(e){ alert('Failed to delete: '+e.message); }
        }

        function showMessageMenu(div){
            closeMessageMenu();
            const idx = Number(div.dataset.index);
            const current = div.querySelector('.message-content').innerText;
            const menu = document.createElement('div');
            menu.className='message-menu';
            const editBtn=document.createElement('button');
            editBtn.textContent='Edit';
            editBtn.onclick=(e)=>{ e.stopPropagation(); closeMessageMenu(); editMessage(idx,current); };
            const delBtn=document.createElement('button');
            delBtn.textContent='Delete';
            delBtn.onclick=(e)=>{ e.stopPropagation(); closeMessageMenu(); deleteMessage(idx); };
            menu.appendChild(editBtn); menu.appendChild(delBtn);
            div.appendChild(menu);
            activeMenu = menu;
            setTimeout(()=>document.addEventListener('click', closeMessageMenu, {once:true}),0);
        }

        function appendMessageToUI(role, content){
            const div=document.createElement('div');
            div.className=`message ${role==='user'?'user-message':'ai-message'}`;
            div.dataset.index = chatContainer.children.length;
            const avatar=document.createElement('div');
            avatar.className=`avatar ${role==='user'?'user-avatar':'ai-avatar'}`;
            avatar.textContent = role==='user' ? (state.settings.userName[0]||'U') : (state.settings.botName[0]||'A');
            const contentDiv=document.createElement('div');
            contentDiv.className='message-content';
            contentDiv.innerHTML=content.replace(/\n/g,'<br>');
            const ctrl=document.createElement('button');
            ctrl.className='message-control-btn';
            ctrl.innerHTML='&#8942;';
            ctrl.title='Options';
            ctrl.onclick=(e)=>{ e.stopPropagation(); showMessageMenu(div); };
            div.appendChild(avatar); div.appendChild(contentDiv); div.appendChild(ctrl);
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addTyping(){
            const div=document.createElement('div'); div.className='message ai-message'; div.id='typing-indicator';
            const avatar=document.createElement('div'); avatar.className='avatar ai-avatar'; avatar.textContent=(state.settings.botName[0]||'A');
            const cont=document.createElement('div'); cont.className='message-content'; cont.textContent='...';
            div.appendChild(avatar); div.appendChild(cont); chatContainer.appendChild(div); scrollToBottom();
        }
        function removeTyping(){ const t=document.getElementById('typing-indicator'); if(t) t.remove(); }

        async function sendMessage(allowEmpty=false){
            const text = userInput.value.trim();
            if(state.isGenerating || !state.currentChatId) return;
            if(text==='' && !allowEmpty) return;
            userInput.value=''; autoResize();
            sendButton.disabled=true; sendOnlyButton.disabled=true;
            sendButton.style.display='none';
            sendOnlyButton.style.display='none';
            stopButton.style.display='inline';
            if(text!=='') appendMessageToUI('user', text);
            addTyping(); state.isGenerating=true;
            abortController = new AbortController();
            try{
                const response = await fetch('/chat/stream', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({
                        chat_id: state.currentChatId,
                        message: text,
                        global_prompt: state.currentPrompt
                    }),
                    signal: abortController.signal
                });
                if(!response.ok) throw new Error(`Server returned ${response.status}`);
                removeTyping();
                appendMessageToUI('assistant','');
                const aiElement = chatContainer.lastChild.querySelector('.message-content');
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                let gotMeta = false;
                let accumulated = '';
                let lineCount = 0;
                let autoscrollStopped = false;
                const scrollLimit = parseInt(state.settings.autoScrollLines) || 0;
                while(true){
                    const {value, done} = await reader.read();
                    if(value){
                        buffer += decoder.decode(value, {stream: !done});
                    }
                    if(!gotMeta){
                        const idx = buffer.indexOf('\n');
                        if(idx !== -1){
                            const metaStr = buffer.slice(0, idx);
                            buffer = buffer.slice(idx + 1);
                            try{
                                const meta = JSON.parse(metaStr);
                                systemPrompt.textContent = meta.prompt || '';
                                systemToggle.style.display = meta.prompt ? 'block' : 'none';
                            }catch{}
                            gotMeta = true;
                        }else if(done){
                            break;
                        }else{
                            continue;
                        }
                    }
                    if(gotMeta && buffer){
                        if(accumulated==='' && buffer.startsWith('\n')){
                            buffer = buffer.replace(/^\n+/, '');
                        }
                        lineCount += (buffer.match(/\n/g) || []).length;
                        accumulated += buffer;
                        lineCount = accumulated.split(/\n/).length;
                        aiElement.innerHTML = accumulated.replace(/\n/g,'<br>');
                        if(!autoscrollStopped){
                            if((scrollLimit>0 && lineCount>=scrollLimit) ||
                               (chatContainer.scrollHeight - chatContainer.scrollTop > chatContainer.clientHeight + 10)){
                                autoscrollStopped = true;
                            }
                        }
                        if(!autoscrollStopped){
                            scrollToBottom();
                        }
                        buffer = '';
                    }
                    if(done) break;
                }
            }catch(err){
                if(err.name!=='AbortError'){
                    console.error('Streaming fetch failed:', err);
                    removeTyping(); appendMessageToUI('assistant','[Error generating response]');
                }
            }finally{
                state.isGenerating=false;
                sendButton.disabled=state.isGenerating;
                sendOnlyButton.disabled=userInput.value.trim()==='' || state.isGenerating;
                stopButton.style.display='none';
                sendButton.style.display='inline';
                sendOnlyButton.style.display='inline';
                userInput.focus();
            }
        }

        async function sendMessageNoGen(){
            const text = userInput.value.trim();
            if(text==='' || state.isGenerating || !state.currentChatId) return;
            userInput.value=''; autoResize();
            sendButton.disabled=true; sendOnlyButton.disabled=true;
            appendMessageToUI('user', text);
            try{
                await fetch('/message', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({chat_id: state.currentChatId, message: text, global_prompt: state.currentPrompt})
                });
            }catch(err){
                console.error('Send only failed:', err);
            }finally{
                sendButton.disabled=state.isGenerating;
                sendOnlyButton.disabled=userInput.value.trim()==='' || state.isGenerating;
                userInput.focus();
            }
        }

        function stopGenerating(){ if(abortController){ abortController.abort(); } }

        function setupEvents(){
            themeSelect.addEventListener('change', e=>applyTheme(e.target.value));
            textSizeSelect.addEventListener('change', e=>applyTextSize(e.target.value));
            // prompt selection handled in render
            openSettingsBtn.addEventListener('click', openSettings);
            settingsSaveBtn.addEventListener('click', saveSettingsFromUI);
            serverSettingsSaveBtn.addEventListener('click', saveServerSettings);
            settingsModal.addEventListener('click', e=>{ if(e.target===settingsModal) closeSettings(); });
            sendButton.addEventListener('click', () => {
                if(userInput.value.trim()===''){
                    if(confirm('Generate with no prompt?')) sendMessage(true);
                } else {
                    sendMessage();
                }
            });
            sendOnlyButton.addEventListener('click', sendMessageNoGen);
            stopButton.addEventListener('click', stopGenerating);
            userInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
            userInput.addEventListener('input', ()=>{ const disGen = state.isGenerating; sendButton.disabled = disGen; sendOnlyButton.disabled = userInput.value.trim()==='' || disGen; autoResize(); });
            userInput.addEventListener('blur', ()=>{ setTimeout(scrollToBottom, 100); });
            newChatButton.addEventListener('click', startNewChat);
            newPromptBtn.addEventListener('click', addNewPrompt);
            systemToggle.addEventListener('click', toggleSystem);
            hideTab.addEventListener('click', hideSidebar);
            chatTab.addEventListener('click', showChatTab);
            promptTab.addEventListener('click', showPromptTab);
            moreTab.addEventListener('click', showMoreTab);
        }

        (async function init(){
            loadSettings();
            loadTheme();
            loadTextSize();
            setupEvents();
            showChatTab();
            await fetchChatList();
            if(state.currentChatId) await loadChat(state.currentChatId);
            await refreshGlobalPromptList();
            await loadServerSettings();
            autoResize();
        })();
    </script>
</body>
</html>
